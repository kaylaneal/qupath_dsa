<?xml version = "1.0" encoding = "UTF-8"?>
<executable>

    <category>QuPath DSA Module</category>
    <title>QuPath</title>
    <description>QuPath accessible for any uploaded script</description>
    <version>0.1.0</version>

    <parameters>
        <label>IO</label>
        <description>Define Input/Output Parameters</description>

        <image>
            <name>inputImageFile</name>
            <label>Input Image</label>
            <description>Input image.</description>
            <index>0</index>
            <channel>input</channel>
        </image>

        <file fileExtensions=".groovy">
            <name>inputGroovyScript</name>
            <label>Groovy Script</label>
            <description>Groovy script for QuPath.</description>
            <index>1</index>
            <channel>input</channel>
        </file>

        <file fileExtensions=".json">
            <name>inputModelFile</name>
            <label>Model File</label>
            <description>JSON file describing thresholder/model/classifier/etc. to be used in script.</description>
            <index>2</index>
            <channel>input</channel>
        </file>

        <region>
            <name>analysis_roi</name>
            <label>Analysis ROI</label>
            <description>Region of Interest (ROI) for analysis. Must be a 4 element vector in the format: (left, top, width, height). Defaults to entire image.</description>
            <longflag>analysis_roi</longflag>
            <default>-1,-1,-1,-1</default>
        </region>

        <file fileExtensions=".json" reference="inputImageFile">
            <name>outputAnnotationFile</name>
            <label>Output File</label>
            <description>Annoations</description>
            <channel>output<channel>
            <longflag>outputAnnotationFile</longflag>
        </file>

    </parameters>

    <parameters advanced = "true">

        <label>WSI Analysis</label>
        <description>Whole Slide Image (WSI) Analysis Parameters</description>

        <double>
            <name>analysis_tile_size</name>
            <label>Analysis Tile Size</label>
            <description>Tile Size for blockwise analysis. Default: 1024.</description>
            <longflag>analysis_tile_size</longflag>
            <default>1024</default>
        </double>

        <double>
            <name>analysis_mag</name>
            <label>Analysis Magnification</label>
            <description>The magnification at which the analysis should be performed. Default: 10</description>
            <longflag>analysis_mag</longflag>
            <default>10</default>
        </double>

        <double>
            <name>min_fgnd_frac</name>
            <label>Minimum Foreground Fraction</label>
            <description>The minimum amount of foreground that must be present in tile for it to be analyzed. Default: 0.25</description>
            <longflag>min_fgnd_frac</longflag>
            <default>0.25</default>
        </double>

    </parameters>

    <parameters advanced = "true">

        <label>Dask</label>
        <description>Dask Parameters</description>

        <string>
            <name>scheduler</name>
            <label>Scheduler Address</label>
            <description>Address of a dask scheduler in the format "127.0.0.1:8786". Not passing this parameter sets up a dask cluster on the local machine. 'multiprocessing' uses Python multiprocessing. 'multithreading' uses Python multiprocessing in threaded mode.</description>
            <longflag>scheduler</longflag>
            <default />
        </string>

        <integer>
            <name>num_workers</name>
            <label>Number of Workers</label>
            <description>Number of dask workers to start while setting up local cluster internally. If a negative value is specified then the number of workers is set to number of CPU cores on the machine minus the number of workers specified.</description>
            <longflag>num_workers</longflag>
            <default>-1</default>
        </integer>

        <integer>
            <name>num_threads_per_worker</name>
            <label>Number of Threads per Worker</label>
            <description>Number of threads to use per worker while setting up a local cluster internally. Must be a positive integer >= 1.</description>
            <longflag>num_threads_per_worker</longflag>
            <default>1</default>
        </integer>

    </parameters>
</executable>